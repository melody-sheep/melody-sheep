name: EXACT Lines Counter
on:
  schedule:
    - cron: '0 12 * * 0'  # Every Sunday at 12 PM UTC
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  exact-count:
    runs-on: ubuntu-latest
    steps:
      - name: 1. Setup
        run: |
          echo "üöÄ Starting EXACT line counter..."
          sudo apt-get update
          sudo apt-get install -y cloc git jq
          
      - name: 2. Get repositories (safe method)
        id: get-repos
        run: |
          echo "üìã Getting repository list (safe mode)..."
          
          # Get repos and save to file instead of output
          curl -s -H "Authorization: token ${{ secrets.GH_TOKEN }}" \
            "https://api.github.com/users/melody-sheep/repos?per_page=100" | \
            jq -r '.[].full_name' > /tmp/repo_list.txt
            
          echo "‚úÖ Repository list saved to file"
          echo "Preview:"
          head -10 /tmp/repo_list.txt
          
      - name: 3. Count EXACT lines (fixed for special chars)
        id: count-exact
        run: |
          echo "üî¢ Counting EXACT lines..."
          
          TOTAL=0
          COUNT=0
          
          # Read from file instead of variable
          while IFS= read -r repo || [ -n "$repo" ]; do
            COUNT=$((COUNT + 1))
            echo ""
            echo "--- [$COUNT] Processing: $repo ---"
            
            # Clean repo name for directory
            clean_name=$(echo "$repo" | sed 's/[^a-zA-Z0-9]/_/g')
            
            # Clone with timeout
            if timeout 60 git clone --depth 1 "https://github.com/$repo.git" "$clean_name" 2>/dev/null; then
              cd "$clean_name"
              
              # Count lines
              repo_lines=$(cloc . --exclude-dir=node_modules,.git,dist,build,__pycache__,vendor \
                --quiet --json 2>/dev/null | jq -r '.SUM.code // 0')
                
              echo "‚úÖ Code lines: $repo_lines"
              TOTAL=$((TOTAL + repo_lines))
              
              # Clean up
              cd ..
              rm -rf "$clean_name"
            else
              echo "‚ö†Ô∏è  Could not clone or empty"
            fi
          done < /tmp/repo_list.txt
          
          echo ""
          echo "üéØ EXACT TOTAL CODE LINES: $TOTAL"
          echo "üìÅ Repositories processed: $COUNT"
          echo ""
          
          # Output safely
          echo "total_lines=$TOTAL" >> $GITHUB_ENV
          
      - name: 4. Update badge
        uses: schneegans/dynamic-badges-action@v1.7.0
        with:
          auth: ${{ secrets.GH_TOKEN }}
          gistID: 1f6d9eddc383fb51a9f4fa0880f0d1fa
          filename: loc.json
          label: "Code Written"
          message: "${{ env.total_lines }}"
          color: 58a6ff
          
      - name: 5. Results
        run: |
          echo "‚úÖ DONE! Total: ${{ env.total_lines }} lines"
          echo "‚è∞ Next automatic run: Every Sunday at 12 PM UTC"
