name: EXACT Lines Counter
on:
  workflow_dispatch:

jobs:
  exact-count:
    runs-on: ubuntu-latest
    steps:
      - name: 1. Setup
        run: |
          echo "ğŸš€ Starting EXACT line counter..."
          sudo apt-get update
          sudo apt-get install -y cloc git
          
      - name: 2. Get ALL repositories
        id: get-repos
        run: |
          echo "ğŸ“‹ Getting your repository list..."
          
          # Get ALL your repos
          repos=$(curl -s -H "Authorization: token ${{ secrets.GH_TOKEN }}" \
            "https://api.github.com/users/melody-sheep/repos?per_page=100" | \
            jq -r '.[].full_name')
            
          echo "Found repositories:"
          echo "$repos"
          echo ""
          echo "repo_list=$repos" >> $GITHUB_OUTPUT
          
      - name: 3. Count EXACT lines from EACH repo
        id: count-exact
        run: |
          echo "ğŸ”¢ Counting EXACT lines from each repository..."
          
          TOTAL=0
          COUNT=0
          
          # Process each repository
          for repo in ${{ steps.get-repos.outputs.repo_list }}; do
            COUNT=$((COUNT + 1))
            echo ""
            echo "--- [$COUNT] $repo ---"
            
            # Clone the repo
            if git clone --depth 1 "https://github.com/$repo.git" temp-repo 2>/dev/null; then
              cd temp-repo
              
              # Use cloc for accurate count (excludes comments/blank lines)
              repo_lines=$(cloc . --exclude-dir=node_modules,.git,dist,build,__pycache__,vendor \
                --quiet --json 2>/dev/null | jq -r '.SUM.code // 0')
                
              echo "âœ… Code lines: $repo_lines"
              TOTAL=$((TOTAL + repo_lines))
              
              # Clean up
              cd ..
              rm -rf temp-repo
            else
              echo "âš ï¸  Could not clone"
            fi
          done
          
          echo ""
          echo "ğŸ¯ EXACT TOTAL CODE LINES: $TOTAL"
          echo "ğŸ“ Repositories processed: $COUNT"
          echo ""
          
          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          
      - name: 4. Update badge with EXACT count
        uses: schneegans/dynamic-badges-action@v1.7.0
        with:
          auth: ${{ secrets.GH_TOKEN }}
          gistID: 1f6d9eddc383fb51a9f4fa0880f0d1fa
          filename: loc.json
          label: "Exact Code"
          message: "${{ steps.count-exact.outputs.total }}"
          color: 58a6ff
          
      - name: 5. Final results
        run: |
          echo "âœ… EXACT COUNT COMPLETE!"
          echo "ğŸ¯ Total lines of ACTUAL CODE: ${{ steps.count-exact.outputs.total }}"
          echo "ğŸ“Š This counts ONLY actual code (no comments, no blanks)"
          echo "ğŸ” Check your README badge for the exact number!"
