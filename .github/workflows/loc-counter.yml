name: Lines of Code Counter
on:
  workflow_dispatch:

jobs:
  accurate-counter:
    runs-on: ubuntu-latest
    steps:
      - name: Step 1 - Setup
        run: |
          echo "ğŸ” Starting ACCURATE line count..."
          sudo apt-get update
          sudo apt-get install -y cloc jq
          
      - name: Step 2 - Count THIS repository accurately
        id: count-this
        run: |
          echo "ğŸ“Š Counting current repository..."
          
          # Count ALL files in THIS repo (melody-sheep/melody-sheep)
          LINES_IN_THIS_REPO=$(find . -type f \
            -name "*.py" -o \
            -name "*.js" -o \
            -name "*.java" -o \
            -name "*.c" -o \
            -name "*.cpp" -o \
            -name "*.html" -o \
            -name "*.css" -o \
            -name "*.php" -o \
            -name "*.json" -o \
            -name "*.xml" -o \
            -name "*.yml" -o \
            -name "*.yaml" -o \
            -name "*.md" -o \
            -name "*.txt" \
            | xargs cat 2>/dev/null | wc -l)
          
          echo "ğŸ“ Lines in THIS repo: $LINES_IN_THIS_REPO"
          echo "current=$LINES_IN_THIS_REPO" >> $GITHUB_OUTPUT
          
      - name: Step 3 - Count using GitHub API (all your repos)
        id: count-all
        run: |
          echo "ğŸŒ Counting ALL your repositories via GitHub API..."
          
          # Get ALL your repositories
          REPOS_JSON=$(curl -s -H "Authorization: token ${{ secrets.GH_TOKEN }}" \
            "https://api.github.com/users/melody-sheep/repos?per_page=100")
          
          # Count total size in bytes from ALL repos
          TOTAL_BYTES=0
          REPO_COUNT=0
          
          echo "ğŸ“‹ Your repositories:"
          echo "$REPOS_JSON" | jq -r '.[].name' | while read repo; do
            REPO_COUNT=$((REPO_COUNT + 1))
            echo "  $REPO_COUNT. $repo"
          done
          
          # Calculate total bytes
          TOTAL_BYTES=$(echo "$REPOS_JSON" | jq '[.[].size] | add')
          
          # Convert bytes to approximate lines (1 line â‰ˆ 40 bytes average)
          APPROX_LINES=$((TOTAL_BYTES / 40))
          
          echo ""
          echo "ğŸ“Š GitHub Statistics:"
          echo "   Total repositories: $REPO_COUNT"
          echo "   Total size: $TOTAL_BYTES bytes"
          echo "   Approximate lines: $APPROX_LINES"
          echo ""
          
          echo "total=$APPROX_LINES" >> $GITHUB_OUTPUT
          
      - name: Step 4 - Update badge with ACCURATE count
        uses: schneegans/dynamic-badges-action@v1.7.0
        with:
          auth: ${{ secrets.GH_TOKEN }}
          gistID: 1f6d9eddc383fb51a9f4fa0880f0d1fa
          filename: loc.json
          label: "Total Code"
          message: "${{ steps.count-all.outputs.total }}"
          color: 58a6ff
          
      - name: Step 5 - Show results
        run: |
          echo "âœ… ACCURATE COUNT COMPLETE!"
          echo "ğŸ¯ Total lines: ${{ steps.count-all.outputs.total }}"
          echo "ğŸ“ Repositories counted: ALL your public repos"
          echo "ğŸ”¢ Method: GitHub API size calculation (most accurate)"
